<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fechamento de Caixa - Seguro</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #fff7e6, #ffe6e6); color: #333; }
    h1 { text-align: center; margin-bottom: 20px; color: #b30000; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.12); display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; color:#b30000; }
    input, select, button { padding: 10px; margin-top: 5px; box-sizing: border-box; font-size: 16px; border-radius: 8px; border:1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 18px; border-radius: 8px; overflow:hidden; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #ffcc00; color:#b30000; font-weight:bold; }
    td { background:#fff; }
    tr:nth-child(even) td { background:#fff8f0; }
    .right { text-align: right; }
    .row { display:grid; grid-template-columns: 1fr 180px; gap:12px; align-items:end; }
    @media(max-width:900px){ .container{ grid-template-columns:1fr; } }
    .date-nav { display:flex; align-items:center; gap:5px; margin-top:5px; }
    .date-nav button { flex:1; padding:8px; font-size:14px; background:#ffcc00; color:#b30000; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    .date-nav button:hover { background:#ffdb4d; }
    button { cursor:pointer; font-weight:bold; border:none; }
    #addBtn { background:#b30000; color:white; }
    #addBtn:hover { background:#cc0000; }
    #detalhesBtn { background:#ffcc00; color:#b30000; }
    #detalhesBtn:hover { background:#ffdb4d; }
    #clearBtn { background:#e60000; color:white; border:none; border-radius:8px; padding:10px; }
    #clearBtn:hover { background:#ff1a1a; }
    #loginBox { max-width: 400px; margin: auto; background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.12); }

    /* Modal */
    #editModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #editModal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 350px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
    }
    #editModal h3 { margin-top: 0; color: #b30000; }
    #editModal button { margin-top: 10px; padding: 10px; border-radius: 8px; width: 48%; }
    #saveEdit { background: #28a745; color:white; }
    #cancelEdit { background: #dc3545; color:white; }
  </style>
</head>
<body>
  <h1>üå∑ Fechamento de Caixa</h1>

  <!-- LOGIN -->
  <div id="loginBox">
    <h2>üë§ Login</h2>
    <input type="email" id="email" placeholder="E-mail" style="width:100%;" /><br><br>
    <input type="password" id="senha" placeholder="Senha" style="width:100%;" /><br><br>
    <button id="loginBtn" style="width:100%;">üö™ Entrar</button>
    <p id="msg" style="color:red;"></p>
  </div>

  <!-- APP -->
  <div id="appBox" style="display:none;">
    <div style="text-align:right; margin-bottom:10px;">
      <button onclick="sair()">üö™ Sair</button>
    </div>

    <div class="container">
      <!-- Tabela de totais -->
      <div>
        <h2 style="color:#b30000;">Totais por Categoria</h2>
        <label for="dataRef">Data</label>
        <div class="date-nav">
          <button id="prevDay">‚óÄ</button>
          <input type="date" id="dataRef" style="flex:2; padding:8px; border:1px solid #ccc; border-radius:6px;" />
          <button id="nextDay">‚ñ∂</button>
        </div>
        <table>
          <thead>
            <tr><th>Categoria</th><th class="right">Total</th></tr>
          </thead>
          <tbody>
            <tr><td>Cart√£o</td><td class="right" id="t_cartao">R$ 0,00</td></tr>
            <tr><td>Cart√£o (Parcelado)</td><td class="right" id="t_cartao_parcelado">R$ 0,00</td></tr>
            <tr><td>PIX (Chave)</td><td class="right" id="t_pix_chave">R$ 0,00</td></tr>
            <tr><td>PIX (M√°quina)</td><td class="right" id="t_pix_maquina">R$ 0,00</td></tr>
            <tr><td>Conv√™nio</td><td class="right" id="t_convenio">R$ 0,00</td></tr>
            <tr><td>Prazo</td><td class="right" id="t_prazo">R$ 0,00</td></tr>
          </tbody>
          <tfoot>
            <tr><th>Saldo Final</th><th class="right" id="t_saldo">R$ 0,00</th></tr>
          </tfoot>
        </table>
        <button id="clearBtn" style="margin-top:10px; width:100%;">üóë Limpar Dados do Dia</button>
      </div>

      <!-- Formul√°rio + lan√ßamentos detalhados -->
      <div>
        <div class="row">
          <div>
            <label for="cat">Categoria</label>
            <select id="cat">
              <option value="cartao">Cart√£o</option>
              <option value="cartao_parcelado">Cart√£o (Parcelado)</option>
              <option value="pix_chave">PIX (Chave)</option>
              <option value="pix_maquina">PIX (M√°quina)</option>
              <option value="convenio">Conv√™nio</option>
              <option value="prazo">Prazo</option>
            </select>
          </div>

          <div>
            <label for="valor">Valor (modo centavos)</label>
            <input type="text" id="valor" inputmode="numeric" placeholder="0,00" autocomplete="off" style="width:100%;" />
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px;">
          <button id="addBtn">‚ûï Adicionar</button>
          <button id="detalhesBtn">üìÑ Ver Lan√ßamentos</button>
        </div>

        <table id="detalhesTable" style="display:none; margin-top:15px;">
          <thead>
            <tr>
              <th>Categoria</th>
              <th class="right">Valor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL DE EDI√á√ÉO -->
  <div id="editModal">
    <div class="modal-content">
      <h3>‚úèÔ∏è Editar Lan√ßamento</h3>
      <label>Categoria</label>
      <select id="editCat" style="width:100%;">
        <option value="cartao">Cart√£o</option>
        <option value="cartao_parcelado">Cart√£o (Parcelado)</option>
        <option value="pix_chave">PIX (Chave)</option>
        <option value="pix_maquina">PIX (M√°quina)</option>
        <option value="convenio">Conv√™nio</option>
        <option value="prazo">Prazo</option>
      </select>
      <label style="margin-top:10px;">Valor</label>
      <input type="text" id="editValor" inputmode="decimal" style="width:100%;" placeholder="0,00" />
      <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <button id="saveEdit">Salvar</button>
        <button id="cancelEdit">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Configura√ß√£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB9ZSQq4pmLgVcC5KMiinTh9y6GKBkaw34",
      authDomain: "caixafechamento-a0c9b.firebaseapp.com",
      projectId: "caixafechamento-a0c9b",
      storageBucket: "caixafechamento-a0c9b.appspot.com",
      messagingSenderId: "973436778587",
      appId: "1:973436778587:web:151a3bb889460ffd65677e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    let dados = [];
    let totals = {};
    let editIndex = null;

    // Helpers
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const normalize = (s) => String(s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const LABEL_TO_KEY = {
      'cartao': 'cartao',
      'cartao (parcelado)': 'cartao_parcelado',
      'pix (chave)': 'pix_chave',
      'pix (maquina)': 'pix_maquina',
      'convenio': 'convenio',
      'prazo': 'prazo',
    };
    const labelToKey = (label) => LABEL_TO_KEY[normalize(label)] || null;
    const keyToLabel = (key) => document.querySelector(`#cat option[value="${key}"]`)?.textContent || key;
    const round2 = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;

    // NOVA FUN√á√ÉO: recalcular totais
    function recalcularTotais() {
      totals = {cartao:0, cartao_parcelado:0, pix_chave:0, pix_maquina:0, convenio:0, prazo:0};
      dados.forEach(d => {
        const key = labelToKey(d.cat);
        if (key) {
          totals[key] = round2((totals[key] || 0) + d.valor);
        }
      });
    }

    // [resto do c√≥digo √© igual at√© EDITAR...]

    // Salvar edi√ß√£o (corrigido p/ usar recalcularTotais)
    document.getElementById('saveEdit').addEventListener('click', () => {
      if (editIndex === null) return;
      const item = dados[editIndex];

      const novaCat = $editCat.value;
      const novoValorNum = parseFloat(String($editValor.value).replace(/\./g,'').replace(',', '.'));
      if (isNaN(novoValorNum) || novoValorNum <= 0) return;

      item.cat = keyToLabel(novaCat);
      item.valor = round2(novoValorNum);

      recalcularTotais();

      editIndex = null;
      $editModal.style.display = 'none';
      salvar(); render();
    });

    // Excluir (corrigido p/ usar recalcularTotais)
    window.excluir = (i) => {
      if (!confirm("Excluir este lan√ßamento?")) return;
      dados.splice(i, 1);
      recalcularTotais();
      salvar(); render();
    };
  </script>
</body>
</html>
